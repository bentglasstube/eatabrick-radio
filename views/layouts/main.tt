<!DOCTYPE html>
<html>
  <head>
    <title>Eat a Brick Radio</title>
    <link rel="stylesheet" href="/style.css" />
    <script type="text/javascript" src="/jquery.min.js"></script>
    <script type="text/javascript">
      var current = {};
      var start = 0;

      function update_meta_info() {
        $.get('/current', function(song) {
          if (song.uri != current.uri) {
            $('#playing img').attr('src', song.image);
            $('#title').text(song.title);
            $('#artist').text(song.artist);
            $('#album').text(song.album);

            current = song;
          }

          start = new Date() - song.pos * 1000;
          update_progress();

          var timeout = 5000;
          var left = song.length - song.pos;
          if (left < 5) timeout = left * 1000;

          setTimeout('update_meta_info()', timeout);
        });
      }

      function update_progress() {
        current.pos = (new Date() - start) / 1000;
        $('#time span').width((current.pos / current.length * 100) + '%');
      }

      $(document).ready(function() {
        update_meta_info();
        setInterval('update_progress()', 100);
      });
    </script>
  </head>

  <body>
    <div id="header">
      <div id="playing"><% include 'current.tt' %></div>
      <img src="/bricky.png" alt="bricky" />
      <h1>Eat a Brick Radio</h1>
      <% include 'nav.tt' %>
    </div>
    
    <div id="body">
      <ul id="flash">
        <% foreach message in session.flash.keys %>
          <li class="<% session.flash.item(message) %>"><% message %></li>
          <% session.flash.delete(message) %>
        <% end %>
      </ul>
      
      <% content %>
    </div>
  </body>
</html>
